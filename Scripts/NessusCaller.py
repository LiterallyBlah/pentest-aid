#!/usr/bin/python
import json
import argparse
import requests
import urllib3
import os


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


class NessusRequest(object):
    # User options (arguments) when running script.
    parser = argparse.ArgumentParser(description='Nessus API. Functionality: Start, Check Status, Download and '
                                                 'List.\nFollowing Options:\n\tCreate Scan: python3 nessus.py -t '
                                                 'google.com -n Google_Scan \n\t\n\tStop Scan: python3 nessus.py -x '
                                                 '219\n\tStatus Scan: python3 nessus.py -s 219\n\tList Scans: python3 '
                                                 'nessus.py -l\n\tOutput Scan: python3 nessus.py -e nessus -o '
                                                 '/home/scutter/Reports/blah.nessus',
                                     formatter_class=argparse.RawTextHelpFormatter)

    parser.add_argument('--targets', '-t', help='Target list. This can be a file or a list of specified targets '
                                                'seperated by spaces.')
    parser.add_argument('--name', '-n', help='Name of scan.')
    parser.add_argument('--listPolicies', '-lp', help='List policies with their IDs', action='store_true')
    parser.add_argument('--setPolicy', '-p', help='Name of policy.')
    parser.add_argument('--status', '-s', help='Current status of scan using ID.')
    parser.add_argument('--stop', '-x', help='Stops scan using ID.')
    parser.add_argument('--export', '-e', help='Export options: Nessus, HTML, PDF, CSV, or DB.')
    parser.add_argument('--output', '-o', help='Output path.')
    parser.add_argument('--list', '-l', help='List Scans with their IDs', action='store_true')

    args = parser.parse_args()

    HEADERS = {}  # Empty Headers json element.

    def __init__(
            self,
            username,  # given value when calling class.
            password,  # given value when calling class.
            host,  # given value when calling class.
            verify=False,
            proxies=None,
            uuid="ad629e16-03b6-8c1d-cef6-ef8c9dd3c658d24bd260ef5f9e66",
            uuidChoice=None,
            folder_id=None,
            policy_id=args.setPolicy,
    ):

        self.VERIFY = verify
        self.PROXIES = proxies

        self.HOST = 'https://' + host
        self.host = host
        self.username = username
        self.password = password
        self.login(username, password, self.HOST)

        self.folder_id = folder_id
        self.policy_id = policy_id
        self.uuid = uuid
        self.uuidChoice = uuidChoice

    def req(self, verb, uri, **kwargs):
        # Changes the func variable based on the verb input.
        if verb == "get":
            func = requests.get
        elif verb == "post":
            func = requests.post
        elif verb == "put":
            func = requests.put
        else:
            func = requests.get
        # calls func with hosts, heads, etc
        return func(
            self.HOST + uri,
            headers=self.HEADERS,
            verify=self.VERIFY,
            proxies=self.PROXIES,
            **kwargs
        )

    def login(self, username, password, host):
        try:
            # We need to get both the API key and the Session token
            global res
            res = self.req("get", "/nessus6.js")

            token_location = res.text.find('getApiToken",value:function(){return')

            self.HEADERS["X-API-TOKEN"] = res.text[
                                          token_location: token_location + 200  # noqa: E203
                                          ].split('"')[2]
            self.HEADERS["Content-Type"] = "application/json"
            data = '{"username":"%s","password":"%s"}' % (username, password)
            res = self.req("post", "/session", data=data)

            self.HEADERS["X-Cookie"] = "token=" + json.loads(res.text)["token"]

        except:
            return print('Unable to login.\n', res)

    def list_scans(self):
        try:
            # requests the /scans and returns the name and status of scans.
            res = json.loads(self.req("get", "/scans").text)
            items = {}
            for item in res['scans']:
                items[item['name']] = item['id']

            for key, value in items.items():
                print(key, ':', value)
        except:
            return print('Unable to retrieve list.\n', res)

    def list_policies(self):
        try:
            # requests the /policies and returns the name and ID of policies.
            res = json.loads(self.req("get", "/policies").text)

            items = {}
            for item in res['policies']:
                items[item['name']] = item['id']

            for key, value in items.items():
                    print('Policy: ', key, ': ', str(value))

        except:
            return print('Unable to retrieve list.\n', res)

    ### MODULES FOR CALLING IN OTHER PYTHON FILES
    def launch_job_module(self, targets, name, policy):
        try:
            data = {
                "uuid": 'ad629e16-03b6-8c1d-cef6-ef8c9dd3c658d24bd260ef5f9e66',
                "settings": {
                    "emails": "",
                    "filter_type": "and",
                    "filters": [],
                    "launch_now": True,
                    "enabled": False,
                    "file_targets": "",
                    "text_targets": targets,
                    "policy_id": policy,
                    "scanner_id": "1",
                    "folder_id": self.folder_id,
                    "description": "Launched by Pentest Report Generator.",
                    "name": name,
                },
            }
            # grabs the above data and sends to /scans. By this point the headers (token, api, cookie, etc) have
            # already been established.
            res = json.loads(self.req("post", "/scans", data=json.dumps(data)).text)
            # Returns scan name and scan id from the response of the request above.
            return print('Scan ID: ', res['scan']['id'])
        except:
            return print('Unable to launch job.\n', res)

    def get_status_module(self, job_id):  ### EDIT THIS
        try:
            # requests the /scans/jobid and returns the info and status.
            res = json.loads(self.req("get", "/scans/{}".format(str(job_id))).text)
            items = {
                "status":  res["info"]["status"]
            }
            return items
        except:
            return print('Unable to retreive status.\n', res)

    # requests the /scans and returns the name and status of scans.
    def list_scans_module(self):
        try:
            res = json.loads(self.req("get", "/scans").text)
            items = {}
            for item in res['scans']:
                items[item['name']] = item['id']
            return items
        except:
            return print('Unable to retrieve list.\n', res)

    # because I couldn't fix this code (which was inspired by another script years ago), I downloaded another script
    # by Nikhil Raj, and I'm calling this script using os.system. (NessusFileDownloader.py)
    # refer to info at the top of NessusFileDownloader. All respects to Nikhil.
    def export_file_module(self, job_id, path):  ### EDIT THIS
        pathToNessusFileDownloader = path + "Scripts/NessusFileDownloader.py"
        command = "python3 {0} -i {1} -u {2} -p {3} -f 0 -s {4}".format(pathToNessusFileDownloader, self.host, self.username, self.password, job_id)
        os.system(command)


#nessus = NessusRequest(main.config['Path to Project'], main.config['Json File'], main.config['Nessus Username'], main.config['Nessus Password'], main.config['Nessus Server'], "", 2)


#def start_scan(target, name, policy):
#    nessus.args.targets = target
#    nessus.args.name = name
#    nessus.args.setPolicy = policy
#    nessus.launch_job()

#if nessus.args.export and nessus.args.output and nessus.args.status:
#    nessus.export_file()
#elif nessus.args.targets and nessus.args.name and nessus.args.setPolicy:
#    nessus.launch_job()
#elif nessus.args.list:
#    nessus.list_scans()
#elif nessus.args.listPolicies:
#    nessus.list_policies()
#elif nessus.args.stop:
#    nessus.stop_job()
#elif nessus.args.status:
#    nessus.get_status()
#else:
#    print('Unknown option or combination of options.\nTry -h or --help for options.')
